name: Release (Windows + Linux + macOS)

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

# æ˜ç¡®æ‰€éœ€æƒé™ï¼ˆç¡®ä¿èƒ½å¤Ÿåˆ›å»º releaseã€ä¸Šä¼  asset ç­‰ï¼‰
permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build:
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        include:
          # Windows (ARM64)
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            arch: arm64

          # macOSï¼ˆApple / Intelï¼‰
          - os: macos-latest
            target: aarch64-apple-darwin
            arch: arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            arch: x86_64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å•æ¬¡è¿è¡Œç»Ÿä¸€çš„æ—¶é—´æˆ³ï¼ˆç”¨äº ?dir= æˆ–å‘½åï¼‰
      - name: Set build timestamp
        shell: bash
        run: |
          TS=$(date +%s)
          echo "UPLOAD_TS=$TS" >> $GITHUB_ENV
          echo "ğŸ“¦ Using upload timestamp: $TS"

      # Node + pnpm
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Show versions
        shell: bash
        run: |
          node -v
          pnpm -v

      # Rust & target
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust Target
        shell: bash
        run: rustup target add ${{ matrix.target }}

      # ---------------- OS-specific deps ----------------
      - name: Install NSIS (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install nsis -y

      - name: macOS deps
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew update
          brew install coreutils jq || true
      # --------------------------------------------------

      - name: Install JS deps
        timeout-minutes: 20
        shell: bash
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NPM_CONFIG_FETCH_RETRIES: "5"
          NPM_CONFIG_FETCH_RETRY_FACTOR: "2"
          NPM_CONFIG_FETCH_RETRY_MINTIMEOUT: "20000"
          NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT: "120000"
        run: |
          set -euxo pipefail
          pnpm store prune || true
          rm -rf node_modules
          pnpm install --frozen-lockfile

      - name: Rebuild esbuild
        shell: bash
        run: |
          set -euxo pipefail
          pnpm rebuild esbuild || true
          npx esbuild --version || true

      - name: Prepare sidecar
        timeout-minutes: 15
        shell: bash
        run: |
          set -euxo pipefail
          pnpm run prebuild ${{ matrix.target }}

      - name: Build frontend
        timeout-minutes: 25
        shell: bash
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          set -euxo pipefail
          pnpm run web:build -- --debug

      # æ— ç§é’¥åˆ™ç§»é™¤ updater.pubkey â€”â€” Windows
      - name: Disable updater signing when no private key (Win)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if ("${{ secrets.TAURI_PRIVATE_KEY }}" -eq "") {
            Write-Host "No TAURI_PRIVATE_KEY â€“ removing updater.pubkey for unsigned build."
            if (Test-Path "src-tauri/tauri.conf.json") {
              Copy-Item src-tauri/tauri.conf.json src-tauri/tauri.conf.json.bak -Force
              (Get-Content src-tauri/tauri.conf.json) |
                Where-Object {$_ -notmatch '"pubkey"\s*:'} |
                Set-Content src-tauri/tauri.conf.json
            }
          } else {
            Write-Host "TAURI_PRIVATE_KEY present â€“ keep pubkey and sign build."
          }

      # æ— ç§é’¥åˆ™ç§»é™¤ updater.pubkey â€”â€” *nixï¼ˆå…¼å®¹ macOS çš„ awkï¼‰
      - name: Disable updater signing when no private key (*nix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [[ -z "${{ secrets.TAURI_PRIVATE_KEY }}" ]]; then
            echo "No TAURI_PRIVATE_KEY â€“ removing updater.pubkey for unsigned build."
            if [[ -f "src-tauri/tauri.conf.json" ]]; then
              cp src-tauri/tauri.conf.json src-tauri/tauri.conf.json.bak
              awk '!/\"pubkey\"[[:space:]]*:/' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
            fi
          else
            echo "TAURI_PRIVATE_KEY present â€“ keep pubkey and sign build."
          fi

      # ------------ Tauri buildï¼šåŸç”Ÿæ„å»ºï¼ˆæˆ– Linux x86_64 åŸç”Ÿï¼‰------------
      - name: Tauri build (native)
        if: runner.os != 'Linux' || matrix.target == 'x86_64-unknown-linux-gnu'
        timeout-minutes: 90
        uses: tauri-apps/tauri-action@v0
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tauriScript: pnpm
          args: --target ${{ matrix.target }}
          includeUpdaterJson: true

      # ---------------- ä¸Šä¼  artifactï¼šæ”¹ä¸º actions/upload-artifact@v4 ----------------
      - name: Collect bundles for artifact upload
        shell: bash
        run: |
          set -euxo pipefail || true
          rm -rf bundles || true
          mkdir -p bundles
          # å¤åˆ¶å¸¸è§çš„æ‰“åŒ…è¾“å‡ºç›®å½•åˆ° bundles ä¸‹ï¼ˆæŒ‰éœ€æ‰©å±•ï¼‰
          cp -r src-tauri/target/**/release/bundle/* bundles/ 2>/dev/null || true
          # æœ‰æ—¶ tauri ä¼šæŠŠ exe / dmg / deb æ”¾åœ¨ release ç›®å½•æ ¹ï¼Œé¢å¤–å†å°è¯•å¤åˆ¶
          cp -r src-tauri/target/**/release/*.exe bundles/ 2>/dev/null || true
          cp -r src-tauri/target/**/release/*.dmg bundles/ 2>/dev/null || true
          cp -r src-tauri/target/**/release/*.zip bundles/ 2>/dev/null || true
          ls -la bundles || true

      - name: Upload bundles artifact
        uses: actions/upload-artifact@v4
        with:
          name: bundles-${{ matrix.os }}-${{ matrix.arch }}
          path: bundles/**

  # ---------- publish jobï¼šæ±‡æ€»æ‰€æœ‰ artifactsï¼Œåˆ›å»º Release å¹¶ä¸Šä¼  assets ----------
  publish:
    name: Create GitHub Release & upload assets
    runs-on: ubuntu-latest
    needs: build
    # ä»…åœ¨ tag push æ—¶æ‰æ‰§è¡Œ
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh || true
          # fallback: try quick install if apt didn't provide gh
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y gh
          fi
          gh --version

      - name: Authenticate gh with GITHUB_TOKEN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GITHUB_TOKEN}" | gh auth login --with-token

      - name: Download all workflow artifacts
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          mkdir -p artifacts
          gh run download "$GITHUB_RUN_ID" --dir artifacts || true
          ls -la artifacts || true

      - name: Create or update Release and upload assets
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euxo pipefail
          TAG="${TAG}"
          TITLE="${TAG} (automated build)"
          NOTES="Automated release created by CI for ${TAG}."
          if [ -n "$(ls -A artifacts 2>/dev/null || true)" ]; then
            # å°è¯•åˆ›å»º releaseï¼ˆè‹¥å·²å­˜åœ¨åˆ™å¤±è´¥å¹¶èµ° uploadï¼‰
            gh release create "$TAG" artifacts/* --title "$TITLE" --notes "$NOTES" || gh release upload "$TAG" artifacts/* --clobber
          else
            gh release create "$TAG" --title "$TITLE" --notes "$NOTES" || echo "Release already exists and no artifacts to upload."
          fi
